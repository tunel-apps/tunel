<h3 id="usage">Usage</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tunel run-app &lt;server&gt; singularity/socket/tunel-django
</code></pre></div></div>

<h4 id="arguments">Arguments</h4>

<div class="fresh-table">
<table class="table">
<thead>
  <th>Name</th>
  <th>Description</th>
  <th>Split By</th>
</thead>
<tbody>
<tr>
   <td>user</td>
   <td>username for logging into Django app (NOT your cluster username), defaults to tunel-user</td>
   <td>NA</td>
</tr>
<tr>
   <td>pass</td>
   <td>password for logging in to Django app (NOT your cluster password), defaults to tunel-pass</td>
   <td>NA</td>
</tr>
<tr>
   <td>workdir</td>
   <td>Working directory for app (and to show file explorer for)</td>
   <td>NA</td>
</tr>
<tr>
   <td>container</td>
   <td>Change the app container used (default is demo ghcr.io/vsoch/tunel-django). Must start with container URI to pull (e.g., docker://)</td>
   <td>NA</td>
</tr>
<tr>
   <td>tag</td>
   <td>Tag of the container to use (defaults to latest)</td>
   <td>NA</td>
</tr>

</tbody></table></div>

<p><br /></p>

<p>If split by is provided, this means the argument takes a list, and you should use this as a delimiter.</p>

<h4 id="needs">Needs</h4>

<ul>
  <li>socket</li>
</ul>

<h3 id="examples">Examples</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Run app on login node with singularity, custom tag "dev"</span>
tunel run-app waffles singularity/socket/tunel-django <span class="nt">--tag</span><span class="o">=</span>dev
<span class="c"># Set a custom user/password (note that the UI is only available to you so this isn't for security)</span>
tunel run-app waffles singularity/socket/tunel-django <span class="nt">--tag</span><span class="o">=</span>dev <span class="nt">--user</span><span class="o">=</span>hello <span class="nt">--pass</span><span class="o">=</span>moto  
</code></pre></div></div>

<h3 id="scripts">Scripts</h3>

<blockquote>
  <p>app.sh</p>
</blockquote>

<p>This app uses the singularity launcher and the following script:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nv">JOB_NAME</span><span class="o">=</span><span class="s2">"{{ jobname }}"</span>
<span class="nv">SOCKET_DIR</span><span class="o">=</span><span class="s2">"{{ scriptdir }}"</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="k">${</span><span class="nv">SOCKET_DIR</span><span class="k">}</span>

<span class="c"># Include Singularity cachedir if not set</span>
<span class="o">{</span>% include <span class="s2">"bash/singularity/set-cache-tmp.sh"</span> %<span class="o">}</span>

<span class="c"># Set WORKDIR, first to args.workdir, then settings.yml workdir, then $HOME</span>
<span class="o">{</span>% include <span class="s2">"bash/set-workdir.sh"</span> %<span class="o">}</span>
<span class="nb">cd</span> <span class="nv">$WORKDIR</span>

<span class="nb">echo</span> <span class="s2">"Job is </span><span class="k">${</span><span class="nv">JOB_NAME</span><span class="k">}</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="s2">"Socket directory is </span><span class="k">${</span><span class="nv">SOCKET_DIR</span><span class="k">}</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="s2">"App working directory is </span><span class="k">${</span><span class="nv">WORKDIR</span><span class="k">}</span><span class="s2">"</span>

<span class="c"># Create .local folder for default modules, if doesn't exist</span>
<span class="o">{</span>% include <span class="s2">"bash/python/create-local.sh"</span> %<span class="o">}</span>

<span class="c"># Remove socket if exists</span>
<span class="o">{</span>% include <span class="s2">"bash/socket/set-socket.sh"</span> %<span class="o">}</span>

<span class="c"># Bind the database</span>
<span class="nv">DB_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">SOCKET_DIR</span><span class="k">}</span>/db

<span class="c"># username and password for django to create</span>
<span class="o">{</span>% include <span class="s2">"bash/set-user-pass.sh"</span> %<span class="o">}</span>

<span class="c"># Load modules requested by user</span>
<span class="o">{</span>% <span class="k">for </span>module <span class="k">in </span>args.modules %<span class="o">}</span>module load <span class="o">{{</span> module <span class="o">}}</span> <span class="o">||</span> <span class="nb">printf</span> <span class="s2">"Could not load {{ module }}</span><span class="se">\n</span><span class="s2">"</span>
<span class="o">{</span>% endfor %<span class="o">}</span>

<span class="c"># Add variables to PATH</span>
<span class="o">{</span>% <span class="k">for </span>path <span class="k">in </span>paths %<span class="o">}</span><span class="nb">export </span><span class="nv">PATH</span><span class="o">={{</span> path <span class="o">}}</span>:<span class="k">${</span><span class="nv">PATH</span><span class="k">}</span>
<span class="o">{</span>% endfor %<span class="o">}</span>

<span class="c"># Just pull to tmp for now so cleaned up</span>
<span class="nv">SIF</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">SINGULARITY_CACHEDIR</span><span class="k">}</span><span class="s2">/tunel-django.sif"</span>
<span class="nv">CONTAINER</span><span class="o">=</span><span class="s2">"{% if args.container %}{{ args.container }}{% else %}docker://ghcr.io/vsoch/tunel-django:{% if args.tag %}{{ args.tag }}{% else %}latest{% endif %}{% endif %}"</span>

<span class="c"># First effort</span>
<span class="k">if </span><span class="nb">command</span> <span class="nt">-v</span> singularity &amp;&gt; /dev/null
<span class="k">then
    </span><span class="nb">printf</span> <span class="s2">"singularity pull </span><span class="k">${</span><span class="nv">CONTAINER</span><span class="k">}</span><span class="se">\n</span><span class="s2">"</span>

    <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="k">${</span><span class="nv">DB_DIR</span><span class="k">}</span>

    <span class="c"># Only pull the container if we do not have it yet</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="s2">"</span><span class="k">${</span><span class="nv">SIF</span><span class="k">}</span><span class="s2">"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
        </span>singularity pull <span class="k">${</span><span class="nv">SIF</span><span class="k">}</span> <span class="k">${</span><span class="nv">CONTAINER</span><span class="k">}</span>
    <span class="k">fi</span>
    
    <span class="c"># The false at the end ensures we aren't using nginx, but rather uwsgi just with sockets</span>
    <span class="nb">printf</span> <span class="s2">"singularity exec --env TUNELDJANGO_SQLITE_DATABASE=</span><span class="k">${</span><span class="nv">SQLITE_DB</span><span class="k">}</span><span class="s2"> --env TUNEL_PASS=******** --env TUNEL_USER=</span><span class="k">${</span><span class="nv">TUNEL_USER</span><span class="k">}</span><span class="s2"> --bind </span><span class="k">${</span><span class="nv">DB_DIR</span><span class="k">}</span><span class="s2">:/code/db --bind </span><span class="k">${</span><span class="nv">WORKDIR</span><span class="k">}</span><span class="s2">:/var/www/data </span><span class="k">${</span><span class="nv">SIF</span><span class="k">}</span><span class="s2"> /bin/bash /code/scripts/run_uwsgi.sh </span><span class="k">${</span><span class="nv">SOCKET</span><span class="k">}</span><span class="s2"> false</span><span class="se">\n</span><span class="s2">"</span>
    <span class="c"># The bind for WORKDIR to /var/www/data ensures the filesystem explorer works</span>
    singularity <span class="nb">exec</span> <span class="nt">--bind</span> <span class="k">${</span><span class="nv">DB_DIR</span><span class="k">}</span>:/code/db <span class="nt">--env</span> <span class="nv">TUNEL_PASS</span><span class="o">=</span><span class="k">${</span><span class="nv">TUNEL_PASS</span><span class="k">}</span> <span class="nt">--env</span> <span class="nv">TUNEL_USER</span><span class="o">=</span><span class="k">${</span><span class="nv">TUNEL_USER</span><span class="k">}</span> <span class="nt">--bind</span> <span class="k">${</span><span class="nv">WORKDIR</span><span class="k">}</span>:/code/data <span class="k">${</span><span class="nv">SIF</span><span class="k">}</span> /bin/bash /code/scripts/run_uwsgi.sh <span class="k">${</span><span class="nv">SOCKET</span><span class="k">}</span> <span class="nb">false
</span><span class="k">else
    </span><span class="nb">printf</span> <span class="s2">"Singularity is not available.</span><span class="se">\n</span><span class="s2">"</span>
<span class="k">fi</span>

</code></pre></div></div>

<p>Have any questions, or want to request a new app or launcher? <a href="https://github.com/vsoch/tunel/issues">Ask us!</a></p>
