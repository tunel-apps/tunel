<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Developer Guide &mdash; Tunel 0.0.14 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sphinx-argparse.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Tunel API" href="../api_reference/modules.html" />
    <link rel="prev" title="User Guide" href="user-guide.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Tunel
          </a>
              <div class="version">
                0.0.14
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="user-guide.html">User Guide</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Developer Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#tunel-apps">Tunel Apps</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#args">Args</a></li>
<li class="toctree-l3"><a class="reference internal" href="#commands">Commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="#includes">Includes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#template-variables">Template Variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#documentation">Documentation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api_reference/modules.html">Tunel API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Tunel</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Getting Started</a> &raquo;</li>
      <li>Developer Guide</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/getting_started/developer-guide.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="developer-guide">
<span id="getting-started-developer-guide"></span><h1>Developer Guide<a class="headerlink" href="#developer-guide" title="Permalink to this heading"></a></h1>
<p>This developer guide includes more complex interactions like contributing
apps and launchers. If you haven’t read <a class="reference internal" href="installation.html#getting-started-installation"><span class="std std-ref">Installation</span></a>
you should do that first.</p>
<section id="tunel-apps">
<h2>Tunel Apps<a class="headerlink" href="#tunel-apps" title="Permalink to this heading"></a></h2>
<p>When you write an app, it comes down to putting an <code class="docutils literal notranslate"><span class="pre">app.yaml</span></code> under some nested
subfolder of the tunel app folders (or a custom one that you’ve created and adding
to your tunel settings under <code class="docutils literal notranslate"><span class="pre">apps_dirs</span></code>.  The yaml should have basic metadata
along with its needs and arguments the user can provide. We require detail (e.g., descriptions)
to ensure that rendering the app into documentation is useful for users.
A basic application might look like the following:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">launcher</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">slurm</span><span class="w"></span>
<span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">jupyter.sbatch</span><span class="w"></span>
<span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">A jupyter notebook (or lab) intended to be run in a Singularity container.</span><span class="w"></span>
<span class="nt">args</span><span class="p">:</span><span class="w"></span>
<span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">jupyterlab</span><span class="w"></span>
<span class="w">   </span><span class="nt">description</span><span class="p">:</span><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">Try running jupyterlab instead (e,g. set to true to enable)</span><span class="w"></span>
<span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">workdir</span><span class="w"></span>
<span class="w">   </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Working directory for the notebook</span><span class="w"></span>
<span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">modules</span><span class="w"></span>
<span class="w">   </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">comma separated list of modules to load</span><span class="w"></span>
<span class="w">   </span><span class="nt">split</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="w"></span>
<span class="nt">needs</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">socket</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
</pre></div>
</div>
<p>Note that all of the fields (except for needs) are required. Args are not required but recommended,
described next.</p>
<section id="args">
<h3>Args<a class="headerlink" href="#args" title="Permalink to this heading"></a></h3>
<dl class="simple">
<dt>Args (“args”) should be a list of arguments, each of which contains a name and description,</dt><dd><p>that can be rendered in your template and user documentation. The field “split”
is not required, but if provided, means that any user provided argument will be split by that
character. As examples of the above:</p>
</dd>
</dl>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>tunel run-app osg slurm/socket/jupyter --workdir<span class="o">=</span>/usr/username/workdir --modules<span class="o">=</span>python/3.7,py-tensorflow
</pre></div>
</div>
</section>
<section id="commands">
<h3>Commands<a class="headerlink" href="#commands" title="Permalink to this heading"></a></h3>
<p>Commands (in the app.yaml, <code class="docutils literal notranslate"><span class="pre">commands:</span></code> might be wanted if, for example, your app generates a login credential
that you want to cat to the terminal for the user. It’s recommended to design your app to have an artificial home
in the <code class="docutils literal notranslate"><span class="pre">$SOCKET_DIR</span></code> and then to designate it as home (e.g., <code class="docutils literal notranslate"><span class="pre">--home</span></code> with singularity. Currently, tunel supports
a post command (for Singularity only) that might look like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">commands</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">post</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cat $socket_dir/home/.config/code-server/config.yaml</span><span class="w"></span>
</pre></div>
</div>
<p>The above will substitute <code class="docutils literal notranslate"><span class="pre">$socket_dir</span></code> with the socket directory on the cluster,
and you will have made the <code class="docutils literal notranslate"><span class="pre">$socket_dir/home</span></code> folder and designated it as <code class="docutils literal notranslate"><span class="pre">--home</span></code>
to singularity. See the singularity/socket/code-server app for an example.</p>
</section>
<section id="includes">
<h3>Includes<a class="headerlink" href="#includes" title="Permalink to this heading"></a></h3>
<p>Since there is often shared logic between apps, we have a shared templates
folder in which you can write snippets that intend to be shared. As an example,
it’s fairly common with Singularity containers to want to check for a cache directory
being set, and if it’s not set, set it somewhere with a lot of space (e.g., a temporary
filesystem). The snippet in bash might look like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">if [ -z ${SINGULARITY_CACHEDIR+x} ]; then</span>
<span class="go">    export SINGULARITY_CACHEDIR=/tmp</span>
<span class="go">fi</span>
</pre></div>
</div>
<p>And then within your templates for a script or sbatch script, instead of needing
to write that out many times (and update each one) you can include the template:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>Include Singularity cachedir <span class="k">if</span> not <span class="nb">set</span>
<span class="go">{% include &quot;bash/singularity-cache-tmp.sh&quot; %}</span>
</pre></div>
</div>
<p>Note that this templates directory is at <code class="docutils literal notranslate"><span class="pre">tunel/templates</span></code> and should be organized
logically (e.g., by language or other relevant context).</p>
</section>
<section id="template-variables">
<h3>Template Variables<a class="headerlink" href="#template-variables" title="Permalink to this heading"></a></h3>
<p>If you write a job file or template, in addition to arguments that the user might
provide on the command line (and you should always set a default for) the following
variables are always available:</p>
<table class="docutils align-default" id="id5">
<caption><span class="caption-text">Template Variables</span><a class="headerlink" href="#id5" title="Permalink to this table"></a></caption>
<colgroup>
<col style="width: 25.0%" />
<col style="width: 65.0%" />
<col style="width: 10.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Default</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>args</p></td>
<td><p>Dictionary of arguments that a user might provide from the command line (e.g., <code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">args.cpus</span> <span class="pre">}}</span></code>.</p></td>
<td><p>{}</p></td>
</tr>
<tr class="row-odd"><td><p>paths</p></td>
<td><p>List of paths derived from the launcher config in settings, plus any from the app.needs.path section of an app.yaml</p></td>
<td><p>[]</p></td>
</tr>
<tr class="row-even"><td><p>jobslug</p></td>
<td><p>The full job name with path separators replaced with single dashes. E.g., <code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">jobslug</span> <span class="pre">}}</span></code> renders to <code class="docutils literal notranslate"><span class="pre">htcondor-job</span></code></p></td>
<td><p>defaults to the job name slugified</p></td>
</tr>
<tr class="row-odd"><td><p>jobname</p></td>
<td><p>The job name, automatically assigned</p></td>
<td><p>defaults to the job name</p></td>
</tr>
<tr class="row-even"><td><p>port</p></td>
<td><p>ssh remote port</p></td>
<td><p>defaults to the default in your settings.yaml</p></td>
</tr>
<tr class="row-odd"><td><p>scriptdir</p></td>
<td><p>the remote assets directory plus the app name</p></td>
<td><p>As an example, <code class="docutils literal notranslate"><span class="pre">${HOME}/tunel/htcondor/job</span></code></p></td>
</tr>
<tr class="row-even"><td><p>socket</p></td>
<td><p>fullpath to a socket file (.sock) in case the job needs one</p></td>
<td><p>As an example, <code class="docutils literal notranslate"><span class="pre">${HOME}/tunel/htcondor/job/htcondor-job.sock</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>script</p></td>
<td><p>fullpath to a main job script (“script” in the app.yaml) post-render</p></td>
<td><p>As an example, <code class="docutils literal notranslate"><span class="pre">${HOME}/tunel/slurm/jupyter/jupyter.sbatch</span></code></p></td>
</tr>
<tr class="row-even"><td><p>script_basename</p></td>
<td><p>The script basename</p></td>
<td><p>As an example, <code class="docutils literal notranslate"><span class="pre">jupyter.sbatch</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>log_output</p></td>
<td><p>log output file (<a href="#id1"><span class="problematic" id="id2">*</span></a>.out) in the scriptdir</p></td>
<td><p>As an example, <code class="docutils literal notranslate"><span class="pre">jupyter.sbatch.out</span></code></p></td>
</tr>
<tr class="row-even"><td><p>log_error</p></td>
<td><p>log error file (<a href="#id3"><span class="problematic" id="id4">*</span></a>.err) in the scriptdir</p></td>
<td><p>As an example, <code class="docutils literal notranslate"><span class="pre">jupyter.sbatch.err</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>log_file</p></td>
<td><p>single logging file (if needed) in the scriptdir</p></td>
<td><p>As an example, <code class="docutils literal notranslate"><span class="pre">jupyter.sbatch.log</span></code></p></td>
</tr>
<tr class="row-even"><td><p>workdir</p></td>
<td><p>If <code class="docutils literal notranslate"><span class="pre">tunel_remote_work</span></code> is defined in settings, this variable first, overridden by –workdir on the command line.</p></td>
<td><p>As an example, <code class="docutils literal notranslate"><span class="pre">/usr/workdir/username/</span></code></p></td>
</tr>
</tbody>
</table>
</section>
<section id="documentation">
<h3>Documentation<a class="headerlink" href="#documentation" title="Permalink to this heading"></a></h3>
<p>Tunel has a special command to generate docs, and they are written to <code class="docutils literal notranslate"><span class="pre">apps</span></code> in the
present working directory that gets built into “apps” of the website. To generate:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>tunel docgen apps/_library/
<span class="go">Generating documentation markdown for htcondor/job</span>
<span class="go">Generating documentation markdown for slurm/socket/singularity-jupyter</span>
<span class="go">Generating documentation markdown for slurm/socket/jupyter</span>
<span class="go">Generating documentation markdown for slurm/port/jupyter</span>
<span class="go">Generating documentation markdown for singularity/socket/jupyter</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="user-guide.html" class="btn btn-neutral float-left" title="User Guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../api_reference/modules.html" class="btn btn-neutral float-right" title="Tunel API" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021-2022, Vanessa Sochat.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>